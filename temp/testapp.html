<!DOCTYPE html>
<html>
<head>
	<title>JavaScript tracker test</title>
</head>
<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.0.min.js"></script>
<script type="text/javascript" src="moment.js"></script>
<style type="text/css">
	.content {margin-left: auto; margin-right: auto; width: 1280px; font-family: verdana;}
	.content h1 {text-align: center;}
	.box {border: solid 2px; width: 47%; display: inline-block; height: 100%; margin: 5px; padding: 10px; overflow: hidden;}
	.box p span { white-space: pre; }
	.fields {width: 100%;}
	.fields td:first-child{ width: 30% }
	.fields td {width: 70%;}
	.extensions td {width: 16%;}
	input { width: 100%; }
</style>
<body>
<script type="text/javascript">

	var tracker = new TrackerAsset();

	var loginButton = function(){
		tracker.url = $("#host").val() + "api/";

		tracker.Login($("#username").val(),$("#password").val(), function(data,error){
			if(!error){
				$( "#login" ).css('background-color','green');
			}else{
				$( "#login" ).css('background-color','red');
			}
		});
	}

	var startButton = function(){
		tracker.url = $("#host").val() + "api/";
		tracker.trackingCode = $("#trackingCode").val();

		tracker.Start(function(result, error){
			if(!error){
				$( "#authToken" ).text(result['authToken']);
				$( "#playerId" ).text(result['playerId']);
				$( "#session" ).text(result['session']);
				$( "#actor" ).text(JSON.stringify(result['actor']));
				$( "#start" ).css('background-color','green');
			}else{
				$( "#start" ).css('background-color','red');
			}
		});
	}

	var trackButton = function(){
		if($("#send_score").is(':checked'))				tracker.setScore($("#score").val());
		if($("#send_completion").is(':checked'))		tracker.setCompletion($("#completion").val());
		if($("#send_success").is(':checked'))			tracker.setSuccess($("#success").val());
		if($("#send_response").is(':checked'))			tracker.setResponse($("#response").val());

		tracker.Trace($("#verb").val(),$("#target_type").val(),$("#target_id").val())
	}

	var addExtensionButton = function(){
		tracker.addExtension($("#key").val(), Number($("#value").val()));
	}

	function TrackerAsset(){
		this.url = "https://rage.e-ucm.es/";
		this.collector = "proxy/gleaner/collector/";
		this.trackingCode = "";

		this.actor = "{}";

		this.authToken = "";
		this.playerId = "";
		this.objectId = "";
		this.session = 0;

		this.extensions = {};

		this.Login = function(username, password, callback){
			var tracker = this;
			$.ajax({
				url: this.url + "login",
				type: 'post',
				data: JSON.stringify({username: username, password: password}),
				headers: {
					'Content-Type': 'application/json'
				},
				dataType: 'json',
				success: function (data) {
					tracker.authToken = data['user']['token'];
					console.info("AuthToken: " + data['user']['token']);
					callback(data, null);
					
				},
				error: function (data) {
					console.info(data);
					callback(data, true)
				}
			});
		}

		this.Start = function(callback){
			var tracker = this;

			var headers = {
				'Content-Type': 'application/json'
			};

			if(this.authToken)
				headers.Authorization = "Bearer " + this.authToken;

			$.ajax({
				url: this.url + this.collector + "start/" + this.trackingCode,
				type: 'post',
				headers: headers,
				dataType: 'json',
				success: function (data) {
					console.info(data);

					tracker.authToken = data['authToken'];
					tracker.actor = data['actor'];
					tracker.playerId = data['playerId'];
					tracker.objectId = null;//data['objectId'];
					tracker.session = data['session'];

					callback(data, null)
				},
				error: function (data) {
					callback(data,true)
				}
			});
		}

		this.Trace = function(verb,type,id){
			var t = new TrackerEvent(this);
			t.setActor(this.actor);
			t.setEvent(new TrackerEvent.TraceVerb(verb));
			t.setTarget(new TrackerEvent.TraceObject(type, id));
			t.setResult(new TrackerEvent.TraceResult());
			t.Result.setExtensions(this.extensions);
			this.extensions = {};

			$( "#csv" ).text(t.ToCsv());
			$( "#xapi" ).text(t.ToXapi());

			$.ajax({
				url: this.url + this.collector + "track",
				type: 'post',
				data: '[' + t.ToXapi() + ']',
				headers: {
					'Authorization': this.authToken,
					'Content-Type': 'application/json'
				},
				dataType: 'json',
				success: function (data) {
					console.info(data);
					$("#result").text(data['message']);
				},
				error: function (data) {
					console.info(data);
					$("#result").text(data['statusText']);
				}
			});
		}

		this.setScore = function(value){
			this.addExtension("score", value);
		}

		this.setCompletion = function(value){
			this.addExtension("completion", value);
		}

		this.setSuccess = function(value){
			this.addExtension("success", value);
		}

		this.setResponse = function(value){
			this.addExtension("response", value);
		}

		this.addExtension = function(key,value){
			this.extensions[key] = value;
		}
	}

	var obsize = function(obj) {
	    var size = 0, key;
	    for (key in obj) {
	        if (obj.hasOwnProperty(key)) size++;
	    }
	    return size;
	};


	function TrackerEvent (tracker){
		this.tracker = tracker;

		this.TimeStamp = Date.now();

		this.Actor;
		this.Event;
		this.Target;
		this.Result;

		this.setActor = function(actor){
			this.Actor = actor;
		}

		this.setEvent = function(event){
			this.Event = event;
			this.Event.parent = this;
		}

		this.setTarget = function(target){
			this.Target = target;
			this.Target.parent = this;
		}

		this.setResult = function(result){
			this.Result = result;
			this.Result.parent = this;
		}

		this.ToCsv = function()
		{
			return this.TimeStamp
				+ "," + this.Event.ToCsv()
				+ "," + this.Target.ToCsv() 
				+ (this.Result == null && this.Result.ToCsv() ? "" : this.Result.ToCsv());
		}

        this.ToXapi = function()
        {
        	var t = {
				actor: this.Actor == null ? {} : this.Actor,
				verb: this.Event.ToXapi(), 
				object: this.Target.ToXapi(),
				timestamp: moment().toISOString()
			};

			if(this.Result != null){
	            var result = this.Result.ToXapi();
	            if (obsize(result) > 0)
	                t.result = result;
	        }

            return JSON.stringify(t, null, 4);
        }
	}

    //#################################################
    //################ NESTED TYPES ###################
    //#################################################

    // Trace Verb

	TrackerEvent.TraceVerb = function(verb)
	{
		this.verb = verb;

		this.ToCsv = function()
        {
            return this.verb.replace(",", "\\,");
        }

        this.ToXapi = function()
        {
            if (TrackerEvent.TraceVerb.VerbIDs.hasOwnProperty(this.verb))
            {
                return {id: TrackerEvent.TraceVerb.VerbIDs[this.verb] };
            }
            else
            {
                return {id: this.verb}
            }
        }
	}

	TrackerEvent.TraceVerb.VerbIDs = {
        initialized: "http://adlnet.gov/expapi/verbs/initialized",
        progressed: "http://adlnet.gov/expapi/verbs/progressed",
        completed: "http://adlnet.gov/expapi/verbs/completed",
        accessed: "https://w3id.org/xapi/seriousgames/verbs/accessed",
        skipped: "http://id.tincanapi.com/verb/skipped",
        selected: "https://w3id.org/xapi/adb/verbs/selected",
        unlocked: "https://w3id.org/xapi/seriousgames/verbs/unlocked",
        interacted: "http://adlnet.gov/expapi/verbs/interacted",
        used: "https://w3id.org/xapi/seriousgames/verbs/used"
    };

    // Trace Target

    TrackerEvent.TraceObject = function(type, id){
    	this.parent;

		this.Type = type.toLowerCase();
		this.ID = id;

		this.ToCsv = function(){
			return this.Type.replace(",","\\,") + "," + this.ID.replace(",", "\\,");
		}

		this.ToXapi = function()
        {
            var typeKey = this.Type;

            if (TrackerEvent.TraceObject.ObjectIDs.hasOwnProperty(this.Type))
            {
                typeKey = TrackerEvent.TraceObject.ObjectIDs[this.Type];
            }

            id = ((this.parent.tracker.objectId != null) ? this.parent.tracker.objectId + '/' + this.Type + '/' : "") + this.ID;
            definition = {type : typeKey};

            return {
	            id: id,
	            definition: definition
	        };
        }
    }

    TrackerEvent.TraceObject.ObjectIDs = {
	    // Completable
	    game: "https://w3id.org/xapi/seriousgames/activity-types/serious-game" ,
	    session: "https://w3id.org/xapi/seriousgames/activity-types/session",
	    level: "https://w3id.org/xapi/seriousgames/activity-types/level",
	    quest: "https://w3id.org/xapi/seriousgames/activity-types/quest",
	    stage: "https://w3id.org/xapi/seriousgames/activity-types/stage",
	    combat: "https://w3id.org/xapi/seriousgames/activity-types/combat",
	    storynode: "https://w3id.org/xapi/seriousgames/activity-types/story-node",
	    race: "https://w3id.org/xapi/seriousgames/activity-types/race",
	    completable: "https://w3id.org/xapi/seriousgames/activity-types/completable",

	    // Acceesible
	    screen: "https://w3id.org/xapi/seriousgames/activity-types/screen" ,
	    srea: "https://w3id.org/xapi/seriousgames/activity-types/area",
	    zone: "https://w3id.org/xapi/seriousgames/activity-types/zone",
	    cutscene: "https://w3id.org/xapi/seriousgames/activity-types/cutscene",
	    accessible: "https://w3id.org/xapi/seriousgames/activity-types/accessible",

	    // Alternative
	    question: "http://adlnet.gov/expapi/activities/question" ,
	    menu: "https://w3id.org/xapi/seriousgames/activity-types/menu",
	    dialog: "https://w3id.org/xapi/seriousgames/activity-types/dialog-tree",
	    path: "https://w3id.org/xapi/seriousgames/activity-types/path",
	    arena: "https://w3id.org/xapi/seriousgames/activity-types/arena",
	    alternative: "https://w3id.org/xapi/seriousgames/activity-types/alternative",

	    // GameObject
	    enemy: "https://w3id.org/xapi/seriousgames/activity-types/enemy" ,
	    npc: "https://w3id.org/xapi/seriousgames/activity-types/non-player-character",
	    item: "https://w3id.org/xapi/seriousgames/activity-types/item",
	    gameobject: "https://w3id.org/xapi/seriousgames/activity-types/game-object"
	};

	// Trace Target

    TrackerEvent.TraceResult = function(){
    	this.parent;

		this.Score = null;
		this.Success = null;
		this.Completion = null;
		this.Response = null;
		this.Extensions = null;

		this.setExtensions = function(extensions){
			this.Extensions = {};

			for (key in extensions) {
		        switch (key.toLowerCase())
                {
                    case "success": 	this.Success = extensions[key]; break;
                    case "completion": 	this.Completion = extensions[key]; break;
                    case "response": 	this.Response = extensions[key]; break;
                    case "score": 		this.Score = extensions[key]; break;
                    default: 			this.Extensions[key] = extensions[key];  break;
                }
		    }
		}

		this.ToCsv = function(){
			var result =
	            ((this.Success!=null) ? ",success" + this.Success.toString() : "")
	            + ((this.Completion!=null) ? ",completion" + this.Completion.toString() : "")
	            + ((this.Response) ? ",response," + this.Response.replace(",", "\\,") : "")
	            + ((this.Score!=null) ? ",score," + this.Score.toString() : "");

	        /*if (Extensions != null && Extensions.Count > 0)
	            foreach (KeyValuePair<string, System.Object> extension in Extensions)
	            {
	                result += "," + extension.Key.Replace(",", "\\,") + ",";
	                if(extension.Value != null)
	                {
	                    if (extension.Value.GetType() == typeof(string))
	                        result += extension.Value.ToString().Replace(",", "\\,");
	                    else if (extension.Value.GetType() == typeof(float))
	                    {
	                        result += ((float)extension.Value).ToString("G", System.Globalization.CultureInfo.InvariantCulture);
	                    }
	                    else if (extension.Value.GetType() == typeof(double))
	                    {
	                        result += ((double)extension.Value).ToString("G", System.Globalization.CultureInfo.InvariantCulture);
	                    }
	                    else if (extension.Value.GetType() == typeof(Dictionary<string,bool>))
	                    {
	                        Dictionary<string, bool> map = (Dictionary<string, bool>)extension.Value;
	                        string smap = "";
	                        foreach(KeyValuePair<string,bool> t in map)
	                        {
	                            smap += t.Key + "=" + t.Value.ToString().ToLower() + "-";
	                        }
	                        result += smap.TrimEnd('-');
	                    }
	                    else
	                    {
	                        result += extension.Value.ToString();
	                    }
	                }
	            }*/

	        return result;
		}

		this.ToXapi = function()
        {
            var ret = {};

            if (this.Success != null)
                ret.success = (this.Success) ? true : false;

            if (this.Completion != null)
                ret.completion = (this.Completion) ? true : false;

            if (this.Response)
                ret.response = this.Response.toString();

            if (this.Score != null)
            {
                ret.score = {raw: Number(this.Score)};
            }

            if( this.Extensions != null && obsize(this.Extensions) > 0){
            	ret.extensions = this.Extensions;
            }

            return ret;
        }
    }
</script>
<div class="content">
	<h1>Tracker Test App</h1>

	<div class="box">
		<h2>Tracker Start</h2>
		<table class="fields">
			<tr>
				<td>Host</td>
				<td><input id="host" type="text" name="host" placeholder="https://host:port/" value="https://rage.e-ucm.es/"></td>
			</tr>
			<tr>
				<td>Tracking Code</td>
				<td><input id="trackingCode" type="text" name="trackingCode" value="58e3779b1043c7006d76d0e07sj9hnzljjo1dcxr"></td>
			</tr>
			<tr>
				<td>User</td>
				<td><input id="username" type="text" name="username"></td>
			</tr>
			<tr>
				<td>Pass</td>
				<td><input id="password" type="password" name="password"></td>
			</tr>
		</table>
		<p><input type="button" id="login" value="Login" onclick="loginButton()"></p>
		<p><input type="button" id="start" value="Start" onclick="startButton()"></p>
	</div>
	<div class="box">
		<p>authToken = <span id="authToken"></span></p>
		<p>playerId = <span id="playerId"></span></p>
		<p>session = <span id="session"></span></p>
		<p>actor = <span id="actor"></span></p>
	</div>
	<div class="box">
		<h2>Trace Sender</h2>
		<h3>Base</h3>
		<table class="fields">
			<tr>
				<td>Verb</td>
				<td><input id="verb" type="text" name="verb"></td>
			</tr>
			<tr>
				<td>Object Type</td>
				<td><input id="target_type" type="text" name="target_type"></td>
			</tr>
			<tr>
				<td>Object ID</td>
				<td><input id="target_id" type="text" name="target_id"></td>
			</tr>
		</table>
		<h3>Result</h3>
		<table class="extensions">
			<tr>
				<th>Name</th><th>Value</th><th>Send?</th><th>Name</th><th>Value</th><th>Send?</th>
			</tr>
			<tr>
				<td>Score</td>
				<td><input id="score" type="number" name="score" min="0" max="1" step="0.1" value="0.5"></td>
				<td><input id="send_score" type="checkbox" name="send_score"></td>

				<td>Success</td>
				<td><input id="success" type="checkbox" name="success"></td>
				<td><input id="send_success" type="checkbox" name="send_success"></td>
			</tr>
			<tr>
			</tr>
			<tr>
				<td>Response</td>
				<td><input id="response" type="text" name="response"></td>
				<td><input id="send_response" type="checkbox" name="send_response"></td>

				<td>Completion</td>
				<td><input id="completion" type="checkbox" name="completion"></td>
				<td><input id="send_completion" type="checkbox" name="send_completion"></td>
			</tr>
			<tr>
				<td>Extension</td>
				<td colspan="2"><input id="key" type="text" name="key"></td>

				<td>Value</td>
				<td><input id="value" type="number" name="value"></td>
				<td><input id="button" type="button" value="Add extension" onclick="addExtensionButton()"></td>
			</tr>
		</table>
		<input type="button" value="Send Trace" onclick="trackButton()">
		<p>result = <span id="result"></span></p>		
	</div>

	<div class="box">
		<p>CSV = <span id="csv"></span></p>
		<p>xAPI = <span id="xapi"></span></p>
</div>

</body>
</html>